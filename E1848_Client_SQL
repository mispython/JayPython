USE DB_SMF
GO

SELECT 
	dt.[Client Code],
	dt.[Client Name],
	dt.[New I/C Number],
	dt.[Date of Birth],
	dt.[Race],
	dt.[Type],
	dt.[Gender],
	dt.[Nationality],
	dt.[Address 1],
	dt.[Address 2],
	dt.[Address 3],
	dt.[Address 4],
	dt.[Postcode],
	dt.[Occupation],
	dt.[Salary],
	dt.[Employer],
	dt.[Office Address 1],
	dt.[Office Address 2],
	dt.[Office Address 3],
	dt.[Office Address 4],
	dt.[OffPostcode],
	dt.[Correspondence Address],
	dt.[Mobile Phone No],
	dt.[Email Address],
	dt.[Joint Name],
	dt.[Joint I/C No],
	dt.[Referrer Client Code],
	dt.[Referrer Client Name],
	dt.[Client Group],
	dt.[Status],
	dt.[Bank Account Number],
	dt.[CDS No],
	dt.[Share Trading Staff],
	dt.[Product],
	dt.[Branch Code],
	dt.[Region Code],
	CAST(ROUND(dt.[Brokerage Rate (1)],2) as VARCHAR(20)) as 'Brokerage Rate (1)',
	CAST(ROUND(dt.[Brokerage Rate (2)],2) as VARCHAR(20)) as 'Brokerage Rate (2)',
	CAST(ROUND(dt.[Brokerage Rate (3)],2) as VARCHAR(20)) as 'Brokerage Rate (3)',
	CAST(ROUND(dt.[Minimum Brokerage (Offline 1)],2) as VARCHAR(20)) as 'Minimum Brokerage (Offline 1)',
	CAST(ROUND(dt.[Minimum Brokerage (Offline 2)],2) as VARCHAR(20)) as 'Minimum Brokerage (Offline 2)',
	CAST(ROUND(dt.[Minimum Brokerage (Offline 3)],2) as VARCHAR(20)) as 'Minimum Brokerage (Offline 3)',
	CAST(ROUND(dt.[Brokerage Rate - Internet (1)],2) as VARCHAR(20)) as 'Brokerage Rate - Internet (1)',
	CAST(ROUND(dt.[Brokerage Rate - Internet (2)],2) as VARCHAR(20)) as 'Brokerage Rate - Internet (2)',
	CAST(ROUND(dt.[Brokerage Rate - Internet (3)],2) as VARCHAR(20)) as 'Brokerage Rate - Internet (3)',
	CAST(ROUND(dt.[Minimum Brokerage (Online 1)],2) as VARCHAR(20)) as 'Minimum Brokerage (Online 1)',
	CAST(ROUND(dt.[Minimum Brokerage (Online 2)],2) as VARCHAR(20)) as 'Minimum Brokerage (Online 2)',
	CAST(ROUND(dt.[Minimum Brokerage (Online 3)],2) as VARCHAR(20)) as 'Minimum Brokerage (Online 3)',
	CAST(ROUND(dt.[Intraday Rate (1)],2) as VARCHAR(20)) as 'Intraday Rate (1)',
	CAST(ROUND(dt.[Intraday Rate (2)],2) as VARCHAR(20)) as 'Intraday Rate (2)',
	CAST(ROUND(dt.[Intraday Rate (3)],2) as VARCHAR(20)) as 'Intraday Rate (3)',
	CAST(ROUND(dt.[Minimum Brokerage (Intraday Offline 1)],2) as VARCHAR(20)) as 'Minimum Brokerage (Intraday Offline 1)',
	CAST(ROUND(dt.[Minimum Brokerage (Intraday Offline 2)],2) as VARCHAR(20)) as 'Minimum Brokerage (Intraday Offline 2)',
	CAST(ROUND(dt.[Minimum Brokerage (Intraday Offline 3)],2) as VARCHAR(20)) as 'Minimum Brokerage (Intraday Offline 3)',
	CAST(ROUND(dt.[Intraday Rate - Internet (1)],2) as VARCHAR(20)) as 'Intraday Rate - Internet (1)',
	CAST(ROUND(dt.[Intraday Rate - Internet (2)],2) as VARCHAR(20)) as 'Intraday Rate - Internet (2)',
	CAST(ROUND(dt.[Intraday Rate - Internet (3)],2) as VARCHAR(20)) as 'Intraday Rate - Internet (2)',
	CAST(ROUND(dt.[Minimum Brokerage (Intraday Online 1)],2) as VARCHAR(20)) as 'Minimum Brokerage (Intraday Online 1)',
	CAST(ROUND(dt.[Minimum Brokerage (Intraday Online 2)],2) as VARCHAR(20)) as 'Minimum Brokerage (Intraday Online 2)',
	CAST(ROUND(dt.[Minimum Brokerage (Intraday Online 3)],2) as VARCHAR(20)) as 'Minimum Brokerage (Intraday Online 3)',
	dt.[Letter of Offer],
	dt.[Application Date],
	dt.[Date of Activation]
FROM
(
SELECT
	ROW_NUMBER() OVER(Partition by CM.ClntTrdgCode Order by ISNULL(XCM.ClntActvDate,CM.ClntApplDate)) as rn,
	CM.ClntTrdgCode as 'Client Code',
	ISNULL(CM.ClntName,'') as 'Client Name',
	ISNULL(CM.ClntNICNo,'') as 'New I/C Number',
	ISNULL(CONVERT(VARCHAR, CM.ClntDOB, 103),'') as 'Date of Birth',
	ISNULL(CM.ClntRace,'') as 'Race',
	ISNULL(CM.ClntType,'') as 'Type',
	ISNULL(CM.ClntGen,'') as 'Gender',
	ISNULL(CM.ClntNat,'') as 'Nationality',
	ISNULL(CM.ClntAdd1,'') as 'Address 1',
	ISNULL(CM.ClntAdd2,'') as 'Address 2',
	ISNULL(CM.ClntAdd3,'') as 'Address 3',
	ISNULL(CM.ClntAdd4,'') as 'Address 4',
	ISNULL(CM.ClntPCode,'') as 'Postcode',
	ISNULL(CM.ClntOccp,'') as 'Occupation',
	ISNULL(SR.Description,'') as 'Salary',
	ISNULL(CM.ClntEplyer,'') as 'Employer',
	ISNULL(CM.ClntOffAdd1,'') as 'Office Address 1',
	ISNULL(CM.ClntOffAdd2,'') as 'Office Address 2',
	ISNULL(CM.ClntOffAdd3,'') as 'Office Address 3',
	ISNULL(CM.ClntOffAdd4,'') as 'Office Address 4',
	ISNULL(CM.ClntOffPCode,'') as 'OffPostcode',
	ISNULL(CM.ClntCorspAdd,'') as 'Correspondence Address',
	ISNULL(CM.ClntMPhone,'') as 'Mobile Phone No',
	ISNULL(CM.ClntEmail,'') as 'Email Address',
	ISNULL(CM.JointClntName,'') as 'Joint Name',
	ISNULL(CM.JointClntNICNo,'') as 'Joint I/C No',
	ISNULL(CM.RefClntCode,'') as 'Referrer Client Code',
	ISNULL(CM.RefClntName,'') as 'Referrer Client Name',
	ISNULL(CM.ClntGrp,'') as 'Client Group',
	CASE CM.ClntStat 
		WHEN 'P' THEN 'Application pending review and approval '
		WHEN 'R' THEN 'Application rejected'
		WHEN 'A' THEN 'Application approved '
		WHEN 'B' THEN 'Suspend Purchases'
		WHEN 'S' THEN 'Suspend Sell'
		WHEN 'L' THEN 'Suspend Both Purchase And Sales'
		WHEN 'T' THEN 'Activated for trading'
		WHEN 'C' THEN 'Closed'
	END as 'Status',
	ISNULL(CM.ClntBkAcNo,'') as 'Bank Account Number',
	ISNULL(CM.ClntCDSNo,'') as 'CDS No',
	ISNULL(CM.OffInChrg,'') as 'Share Trading Staff',
	ISNULL(CM.ProdCode,'') as 'Product',
	ISNULL(mcbr.CoBrchCode,'') as 'Branch Code',
	ISNULL(mcbr.CoRegionCode,'') as 'Region Code',
---Brokerage Offline-Starts
	ISNULL((
		SELECT ISNULL(B1.BrokerageRate,0)/10000
		FROM
		(
			SELECT 
			ROW_NUMBER() OVER(ORDER BY FromAmt) as rn,
			ClntTrdgCode,
			BrokerageRate,
			BasedBrokerage
			FROM ClntBrk WITH (NOLOCK) WHERE ClntTrdgCode=CM.ClntTrdgCode
		) B1
		WHERE B1.rn=1
	),0) as 'Brokerage Rate (1)',
	ISNULL((
		SELECT ISNULL(B1.BrokerageRate,0)/10000
		FROM
		(
			SELECT 
			ROW_NUMBER() OVER(ORDER BY FromAmt) as rn,
			ClntTrdgCode,
			BrokerageRate,
			BasedBrokerage
			FROM ClntBrk WITH (NOLOCK) WHERE ClntTrdgCode=CM.ClntTrdgCode
		) B1
		WHERE B1.rn=2
	),0) as 'Brokerage Rate (2)',
	ISNULL((
		SELECT ISNULL(B1.BrokerageRate,0)/10000
		FROM
		(
			SELECT 
			ROW_NUMBER() OVER(ORDER BY FromAmt) as rn,
			ClntTrdgCode,
			BrokerageRate,
			BasedBrokerage
			FROM ClntBrk WITH (NOLOCK) WHERE ClntTrdgCode=CM.ClntTrdgCode
		) B1
		WHERE B1.rn=3
	),0) as 'Brokerage Rate (3)',
	ISNULL((
		SELECT ISNULL(B1.BasedBrokerage,0)/100
		FROM
		(
			SELECT 
			ROW_NUMBER() OVER(ORDER BY FromAmt) as rn,
			ClntTrdgCode,
			BrokerageRate,
			BasedBrokerage
			FROM ClntBrk WITH (NOLOCK) WHERE ClntTrdgCode=CM.ClntTrdgCode
		) B1
		WHERE B1.rn=1
	),0) as 'Minimum Brokerage (Offline 1)',
	ISNULL((
		SELECT ISNULL(B1.BasedBrokerage,0)/100
		FROM
		(
			SELECT 
			ROW_NUMBER() OVER(ORDER BY FromAmt) as rn,
			ClntTrdgCode,
			BrokerageRate,
			BasedBrokerage
			FROM ClntBrk WITH (NOLOCK) WHERE ClntTrdgCode=CM.ClntTrdgCode
		) B1
		WHERE B1.rn=2
	),0) as 'Minimum Brokerage (Offline 2)',
	ISNULL((
		SELECT ISNULL(B1.BasedBrokerage,0)/100
		FROM
		(
			SELECT 
			ROW_NUMBER() OVER(ORDER BY FromAmt) as rn,
			ClntTrdgCode,
			BrokerageRate,
			BasedBrokerage
			FROM ClntBrk WITH (NOLOCK) WHERE ClntTrdgCode=CM.ClntTrdgCode
		) B1
		WHERE B1.rn=3
	),0) as 'Minimum Brokerage (Offline 3)',
---Brokerage Offline-Ends
---Brokerage Online-Starts
	ISNULL((
		SELECT ISNULL(B1.BrokerageRate,0)/10000
		FROM
		(
			SELECT 
			ROW_NUMBER() OVER(ORDER BY FromAmt) as rn,
			ClntTrdgCode,
			BrokerageRate,
			BasedBrokerage
			FROM ClntBrkOnl WITH (NOLOCK) WHERE ClntTrdgCode=CM.ClntTrdgCode
		) B1
		WHERE B1.rn=1
	),0) as 'Brokerage Rate - Internet (1)',
	ISNULL((
		SELECT ISNULL(B1.BrokerageRate,0)/10000
		FROM
		(
			SELECT 
			ROW_NUMBER() OVER(ORDER BY FromAmt) as rn,
			ClntTrdgCode,
			BrokerageRate,
			BasedBrokerage
			FROM ClntBrkOnl WITH (NOLOCK) WHERE ClntTrdgCode=CM.ClntTrdgCode
		) B1
		WHERE B1.rn=2
	),0) as 'Brokerage Rate - Internet (2)',
	ISNULL((
		SELECT ISNULL(B1.BrokerageRate,0)/10000
		FROM
		(
			SELECT 
			ROW_NUMBER() OVER(ORDER BY FromAmt) as rn,
			ClntTrdgCode,
			BrokerageRate,
			BasedBrokerage
			FROM ClntBrkOnl WITH (NOLOCK) WHERE ClntTrdgCode=CM.ClntTrdgCode
		) B1
		WHERE B1.rn=3
	),0) as 'Brokerage Rate - Internet (3)',
	ISNULL((
		SELECT ISNULL(B1.BasedBrokerage,0)/100
		FROM
		(
			SELECT 
			ROW_NUMBER() OVER(ORDER BY FromAmt) as rn,
			ClntTrdgCode,
			BrokerageRate,
			BasedBrokerage
			FROM ClntBrkOnl WITH (NOLOCK) WHERE ClntTrdgCode=CM.ClntTrdgCode
		) B1
		WHERE B1.rn=1
	),0) as 'Minimum Brokerage (Online 1)',
	ISNULL((
		SELECT ISNULL(B1.BasedBrokerage,0)/100
		FROM
		(
			SELECT 
			ROW_NUMBER() OVER(ORDER BY FromAmt) as rn,
			ClntTrdgCode,
			BrokerageRate,
			BasedBrokerage
			FROM ClntBrkOnl WITH (NOLOCK) WHERE ClntTrdgCode=CM.ClntTrdgCode
		) B1
		WHERE B1.rn=2
	),0) as 'Minimum Brokerage (Online 2)',
	ISNULL((
		SELECT ISNULL(B1.BasedBrokerage,0)/100
		FROM
		(
			SELECT 
			ROW_NUMBER() OVER(ORDER BY FromAmt) as rn,
			ClntTrdgCode,
			BrokerageRate,
			BasedBrokerage
			FROM ClntBrkOnl WITH (NOLOCK) WHERE ClntTrdgCode=CM.ClntTrdgCode
		) B1
		WHERE B1.rn=3
	),0) as 'Minimum Brokerage (Online 3)',
---Brokerage Online-Ends
---Brokerage Intraday Offline-Starts
	ISNULL((
		SELECT ISNULL(B1.BrokerageRate,0)/10000
		FROM
		(
			SELECT 
			ROW_NUMBER() OVER(ORDER BY FromAmt) as rn,
			ClntTrdgCode,
			BrokerageRate,
			BasedBrokerage
			FROM ClntBrkIntr WITH (NOLOCK) WHERE ClntTrdgCode=CM.ClntTrdgCode
		) B1
		WHERE B1.rn=1
	),0) as 'Intraday Rate (1)',
	ISNULL((
		SELECT ISNULL(B1.BrokerageRate,0)/10000
		FROM
		(
			SELECT 
			ROW_NUMBER() OVER(ORDER BY FromAmt) as rn,
			ClntTrdgCode,
			BrokerageRate,
			BasedBrokerage
			FROM ClntBrkIntr WITH (NOLOCK) WHERE ClntTrdgCode=CM.ClntTrdgCode
		) B1
		WHERE B1.rn=2
	),0) as 'Intraday Rate (2)',
	ISNULL((
		SELECT ISNULL(B1.BrokerageRate,0)/10000
		FROM
		(
			SELECT 
			ROW_NUMBER() OVER(ORDER BY FromAmt) as rn,
			ClntTrdgCode,
			BrokerageRate,
			BasedBrokerage
			FROM ClntBrkIntr WITH (NOLOCK) WHERE ClntTrdgCode=CM.ClntTrdgCode
		) B1
		WHERE B1.rn=3
	),0) as 'Intraday Rate (3)',
	ISNULL((
		SELECT ISNULL(B1.BasedBrokerage,0)/100
		FROM
		(
			SELECT 
			ROW_NUMBER() OVER(ORDER BY FromAmt) as rn,
			ClntTrdgCode,
			BrokerageRate,
			BasedBrokerage
			FROM ClntBrkIntr WITH (NOLOCK) WHERE ClntTrdgCode=CM.ClntTrdgCode
		) B1
		WHERE B1.rn=1
	),0) as 'Minimum Brokerage (Intraday Offline 1)',
	ISNULL((
		SELECT ISNULL(B1.BasedBrokerage,0)/100
		FROM
		(
			SELECT 
			ROW_NUMBER() OVER(ORDER BY FromAmt) as rn,
			ClntTrdgCode,
			BrokerageRate,
			BasedBrokerage
			FROM ClntBrkIntr WITH (NOLOCK) WHERE ClntTrdgCode=CM.ClntTrdgCode
		) B1
		WHERE B1.rn=2
	),0) as 'Minimum Brokerage (Intraday Offline 2)',
	ISNULL((
		SELECT ISNULL(B1.BasedBrokerage,0)/100
		FROM
		(
			SELECT 
			ROW_NUMBER() OVER(ORDER BY FromAmt) as rn,
			ClntTrdgCode,
			BrokerageRate,
			BasedBrokerage
			FROM ClntBrkIntr WITH (NOLOCK) WHERE ClntTrdgCode=CM.ClntTrdgCode
		) B1
		WHERE B1.rn=3
	),0) as 'Minimum Brokerage (Intraday Offline 3)',
---Brokerage Intraday Offline-Ends
---Brokerage Intraday Online-Starts
	ISNULL((
		SELECT ISNULL(B1.BrokerageRate,0)/10000
		FROM
		(
			SELECT 
			ROW_NUMBER() OVER(ORDER BY FromAmt) as rn,
			ClntTrdgCode,
			BrokerageRate,
			BasedBrokerage
			FROM ClntBrkIntrOnl WITH (NOLOCK) WHERE ClntTrdgCode=CM.ClntTrdgCode
		) B1
		WHERE B1.rn=1
	),0) as 'Intraday Rate - Internet (1)',
	ISNULL((
		SELECT ISNULL(B1.BrokerageRate,0)/10000
		FROM
		(
			SELECT 
			ROW_NUMBER() OVER(ORDER BY FromAmt) as rn,
			ClntTrdgCode,
			BrokerageRate,
			BasedBrokerage
			FROM ClntBrkIntrOnl WITH (NOLOCK) WHERE ClntTrdgCode=CM.ClntTrdgCode
		) B1
		WHERE B1.rn=2
	),0) as 'Intraday Rate - Internet (2)',
	ISNULL((
		SELECT ISNULL(B1.BrokerageRate,0)/10000
		FROM
		(
			SELECT 
			ROW_NUMBER() OVER(ORDER BY FromAmt) as rn,
			ClntTrdgCode,
			BrokerageRate,
			BasedBrokerage
			FROM ClntBrkIntrOnl WITH (NOLOCK) WHERE ClntTrdgCode=CM.ClntTrdgCode
		) B1
		WHERE B1.rn=3
	),0) as 'Intraday Rate - Internet (3)',
	ISNULL((
		SELECT ISNULL(B1.BasedBrokerage,0)/100
		FROM
		(
			SELECT 
			ROW_NUMBER() OVER(ORDER BY FromAmt) as rn,
			ClntTrdgCode,
			BrokerageRate,
			BasedBrokerage
			FROM ClntBrkIntrOnl WITH (NOLOCK) WHERE ClntTrdgCode=CM.ClntTrdgCode
		) B1
		WHERE B1.rn=1
	),0) as 'Minimum Brokerage (Intraday Online 1)',
	ISNULL((
		SELECT ISNULL(B1.BasedBrokerage,0)/100
		FROM
		(
			SELECT 
			ROW_NUMBER() OVER(ORDER BY FromAmt) as rn,
			ClntTrdgCode,
			BrokerageRate,
			BasedBrokerage
			FROM ClntBrkIntrOnl WITH (NOLOCK) WHERE ClntTrdgCode=CM.ClntTrdgCode
		) B1
		WHERE B1.rn=2
	),0) as 'Minimum Brokerage (Intraday Online 2)',
	ISNULL((
		SELECT ISNULL(B1.BasedBrokerage,0)/100
		FROM
		(
			SELECT 
			ROW_NUMBER() OVER(ORDER BY FromAmt) as rn,
			ClntTrdgCode,
			BrokerageRate,
			BasedBrokerage
			FROM ClntBrkIntrOnl WITH (NOLOCK) WHERE ClntTrdgCode=CM.ClntTrdgCode
		) B1
		WHERE B1.rn=3
	),0) as 'Minimum Brokerage (Intraday Online 3)',
---Brokerage Intraday Online-Ends
	ISNULL(CONVERT(VARCHAR, CM.OfferDate, 103),'') as 'Letter of Offer',
	ISNULL(CONVERT(VARCHAR, CM.ClntApplDate, 103),'') as 'Application Date',
	ISNULL(CONVERT(VARCHAR, ISNULL(XCM.ClntActvDate,CM.ClntApplDate), 103),'') as 'Date of Activation'
FROM
	ClntMaster CM WITH (NOLOCK)
JOIN 
	MstCoBrch AS mcbr WITH (NOLOCK) ON mcbr.CoBrchCode = CM.CoBrchCode AND mcbr.CoCode = CM.CoCode
JOIN 
	MstRegion AS mreg WITH (NOLOCK) ON mreg.RegionCode = mcbr.CoRegionCode
LEFT JOIN
	(
		SELECT 
		DISTINCT (XCMN.ClntTrdgCode) AS ClntTrdgCode, XCMN.LogAction AS LogAction ,XCMN.ClntStat AS ClntStat,CAST(XCMN.LogDate AS DATE) AS ClntActvDate
		FROM XLogClntMaster XCMO WITH (NOLOCK) 
		INNER JOIN  XLogClntMaster XCMN WITH (NOLOCK) on XCMN.ClntTrdgCode = XCMO.ClntTrdgCode AND XCMO.LogAction = 'O' AND XCMO.ClntStat IS NULL 
		WHERE XCMN.LogAction = 'N' AND XCMN.ClntStat = 'T' AND DATEDIFF(DAY,XCMO.LogDate,XCMN.LogDate) = 0 AND  DATEDIFF(DAY,XCMN.ClntApplDate,XCMN.LogDate)>=0
	) XCM ON XCM.ClntTrdgCode = CM.ClntTrdgCode
LEFT JOIN
	MstSalaryRange SR WITH (NOLOCK) ON CM.SalaryCode = SR.Code
WHERE
	RIGHT(CM.ClntTrdgCode,3) != 'IST'
) as dt
WHERE
	rn=1
ORDER BY
	1
