SAS version


/* Get ProcessDate from the ProcessDate table */
proc sql noprint;
    select put(ProcessDate, date9.) into :ProcDate 
    from DB_SMF.ProcessDate(obs=1);
quit;

/* Calculate Previous Year date */
data _null_;
    ProcDate_num = input("&ProcDate", date9.);
    PrevYear_num = intnx('year', ProcDate_num, -1, 'same');
    call symput('PrevYear', put(PrevYear_num, date9.));
    call symput('ProcDate_num', put(ProcDate_num, 8.));
    call symput('PrevYear_num', put(PrevYear_num, 8.));
run;

%put Process Date: &ProcDate (&ProcDate_num);
%put Previous Year: &PrevYear (&PrevYear_num);

/* Main query */
proc sql;
    create table result as
    select 
        coalesce(cmst.ClntTrdgCode, '') as Client_Code,
        coalesce(cmst.ClntCDSNo, '') as CDS_AC_No,
        coalesce(cmst.ProdCode, '') as Product_Type,
        coalesce(mcbr.CoBrchCode, '') as Branch_Code,
        coalesce(mcbr.CoRegionCode, '') as Region_Code,
        put(round(coalesce(YR.TOVR, 0), 0.01), 20.2) as YTD_Turnover,
        put(round(coalesce(PREVYR.TOVR, 0), 0.01), 20.2) as Previous_Year_Turnover,
        put(round(coalesce(YR.BRKG, 0), 0.01), 20.2) as YTD_Brokerage,
        put(round(coalesce(PREVYR.BRKG, 0), 0.01), 20.2) as Previous_Year_Brokerage,
        case cmst.ClntStat 
            when 'P' then 'Application pending review and approval'
            when 'R' then 'Application rejected'
            when 'A' then 'Application approved'
            when 'B' then 'Suspend Purchases'
            when 'S' then 'Suspend Sell'
            when 'L' then 'Suspend Both Purchase And Sales'
            when 'T' then 'Activated for trading'
            when 'C' then 'Closed'
        end as AC_Status,
        put(round(coalesce(cacct.ActStkFact, 0), 0.01), 20.2) as Stock_Facility_Actual,
        put(round(coalesce(cacct.ComStkFact, 0), 0.01), 20.2) as Stock_Facility_Committed,
        put(round(coalesce(cacct.ActOSBal, 0), 0.01), 20.2) as OS_Balance_Actual,
        put(round(coalesce(cacct.ComOsBal, 0), 0.01), 20.2) as OS_Balance_Committed,
        put(round(coalesce(cacct.ActLsr, 0), 0.01), 20.2) as LSR_Pct_Actual,
        put(round(coalesce(cacct.ComLSR, 0), 0.01), 20.2) as LSR_Pct_Committed,
        put(round(coalesce(cacct.ActShare, 0), 0.01), 20.2) as Shares_Actual,
        put(round(coalesce(cacct.comshare, 0), 0.01), 20.2) as Shares_Committed,
        put(round(coalesce(cacct.fdval, 0), 0.01), 20.2) as FD_Value,
        put(round(coalesce(cacct.comshare, 0) + coalesce(cacct.PropVal, 0), 0.01), 20.2) as Other_Coll,
        put(round(coalesce(cacct.TrdgBal, 0), 0.01), 20.2) as Trading_Balance,
        put(round(coalesce(cacct.CshMrgnBal, 0), 0.01), 20.2) as Cash_Margin_Balance,
        put(round(coalesce(cmst.ClntApprTrdgLmt, 0), 0.01), 20.2) as Approved_Trading_Lmt,
        put(round(coalesce(cacct.ActOSBal, 0), 0.01), 20.2) as Available_Balance,
        put(round(coalesce(cmst.ClntODIntAcc, 0), 0.01), 20.2) as OD_INT_ACC,
        put(round(coalesce(cmst.ClntPCYODAcc, 0), 0.01), 20.2) as PCY_OD_ACC,
        put(cacct.VioPosition, 20.2) as Position,
        put(round(coalesce(cacct.MinShrSell, 0), 0.01), 20.2) as Min_Share_to_sell,
        put(round(coalesce(cacct.ActOsBal, 0) - coalesce(cmst.ClntCrLmt, 0), 0.01), 20.2) as Excesses_Amt,
        put(round(coalesce(cacct.MinCashTopUp, 0), 0.01), 20.2) as Min_Cash_To_Top_Up,
        put(round(coalesce(cacct.MinShrPledge, 0), 0.01), 20.2) as Min_Share_To_Pledge,
        put(round(coalesce(cacct.ComOsBal, 0) - coalesce(cmst.ClntCrLmt, 0), 0.01), 20.2) as Possible_Excess_Amt,
        coalesce(cmst.ClntBkAcNo, '') as AC_No,
        put(coalesce(cmst.ClntCrLmt, 0), 20.2) as Credit_Limit,
        put(round(coalesce(otrd.ComBuy, 0), 0.01), 20.2) as Total_Committed_Buy,
        put(round(coalesce(otrd.DirBuy, 0), 0.01), 20.2) as Direct_Buy,
        put(round(coalesce(otrd.OsSell, 0), 0.01), 20.2) as Outstanding_Sell,
        put(round(coalesce(otrd.Gain, 0), 0.01), 20.2) as Gain,
        put(round(coalesce(otrd.Loss, 0), 0.01), 20.2) as Loss
    from 
        DB_SMF.ClntMaster as cmst
    inner join 
        DB_SMF.ClntActSumm as cacct 
        on cacct.ClntTrdgCode = cmst.ClntTrdgCode
    inner join 
        DB_SMF.ClntCurrLmt as clmt 
        on clmt.ClntCode = cmst.ClntTrdgCode
    inner join 
        DB_SMF.MstCoBrch as mcbr 
        on mcbr.CoBrchCode = cmst.CoBrchCode 
        and mcbr.CoCode = cmst.CoCode
    inner join 
        DB_SMF.MstRegion as mreg 
        on mreg.RegionCode = mcbr.CoRegionCode
    left join 
        DB_SMF.OsTradeSumm as otrd 
        on otrd.ClntTrdgCode = cmst.ClntTrdgCode
    left join 
        (select 
            ClntCode, 
            ContDate, 
            sum(coalesce(ContClntBrkg, 0) - coalesce(ContBrkgRebate, 0)) as TotalBrkg
         from DB_SMF.Contsumm 
         group by ClntCode, ContDate
        ) as A 
        on A.ClntCode = cmst.Clntcode 
        and A.ContDate = &ProcDate_num
    left join
        (select 
            sum(abs(coalesce(ContVal, 0))) as TOVR,
            sum(coalesce(ContClntBrkg, 0)) as BRKG,
            ClntCode
         from DB_SMF.Contsumm
         where year(ContDate) = year(&ProcDate_num)
         group by ClntCode
        ) as YR 
        on cmst.ClntTrdgCode = YR.ClntCode
    left join
        (select 
            sum(abs(coalesce(ContVal, 0))) as TOVR,
            sum(coalesce(ContClntBrkg, 0)) as BRKG,
            ClntCode
         from DB_SMF.Contsumm
         where year(ContDate) = year(&PrevYear_num)
         group by ClntCode
        ) as PREVYR 
        on cmst.ClntTrdgCode = PREVYR.ClntCode
    where 
        cmst.ClntTrdgCode not like '%IST' 
        and cmst.ClntStat ne 'C'
    order by
        cmst.ClntTrdgCode;
quit;

/* Display results */
proc print data=result(obs=10);
    title "First 10 Records of Client Trading Data";
run;

/* Check record count */
proc sql;
    select count(*) as Total_Records from result;
quit;
