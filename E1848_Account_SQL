USE DB_SMF
GO

DECLARE @ProcDate DATETIME
DECLARE @PrevYear DATETIME
SELECT TOP 1 @ProcDate = ProcessDate FROM ProcessDate 
SET @PrevYear = DATEADD(year, -1, @ProcDate)


SELECT 
	ISNULL(cmst.ClntTrdgCode,'') as 'Client Code',
	ISNULL(cmst.ClntCDSNo,'') as 'CDS A/C No',
	ISNULL(cmst.ProdCode,'') as 'Product Type',
	ISNULL(mcbr.CoBrchCode,'') as 'Branch Code',
	ISNULL(mcbr.CoRegionCode,'') as 'Region Code',
	CAST(ROUND(ISNULL( YR.TOVR , 0),2) as VARCHAR(20)) as 'YTD Turnover',
	CAST(ROUND(ISNULL( PREVYR.TOVR , 0),2) as VARCHAR(20)) as 'Previous Year Turnover',
	CAST(ROUND(ISNULL( YR.BRKG , 0),2) as VARCHAR(20)) as 'YTD Brokerage',
	CAST(ROUND(ISNULL( PREVYR.BRKG , 0),2) as VARCHAR(20)) as 'Previous Year Brokerage',
	CASE cmst.ClntStat 
		WHEN 'P' THEN 'Application pending review and approval '
		WHEN 'R' THEN 'Application rejected'
		WHEN 'A' THEN 'Application approved '
		WHEN 'B' THEN 'Suspend Purchases'
		WHEN 'S' THEN 'Suspend Sell'
		WHEN 'L' THEN 'Suspend Both Purchase And Sales'
		WHEN 'T' THEN 'Activated for trading'
		WHEN 'C' THEN 'Closed'
	END as 'A/C Status',
	CAST(ROUND(ISNULL(cacct.ActStkFact, 0),2) as VARCHAR(20)) as 'Stock Facility (Actual)',
	CAST(ROUND(ISNULL(cacct.ComStkFact, 0),2) as VARCHAR(20)) as 'Stock Facility (Committed)',
	CAST(ROUND(ISNULL(cacct.ActOSBal, 0),2) as VARCHAR(20)) as 'O/S Balance (Actual)',
	CAST(ROUND(ISNULL(cacct.ComOsBal, 0),2) as VARCHAR(20)) as 'O/S Balance (Committed)',
	CAST(ROUND(ISNULL(cacct.ActLsr, 0),2) as VARCHAR(20)) as 'LSR % (Actual)',
	CAST(ROUND(ISNULL(cacct.ComLSR,0),2) as VARCHAR(20)) as 'LSR % (Committed)', 
	CAST(ROUND(ISNULL(cacct.ActShare, 0),2) as VARCHAR(20)) as 'Shares (Actual)', 
	CAST(ROUND(ISNULL(cacct.comshare, 0),2) as VARCHAR(20)) as 'Shares (Committed)', 
	CAST(ROUND(ISNULL(cacct.fdval, 0),2) as VARCHAR(20)) as 'FD Value', 
	CAST(ROUND(ISNULL(cacct.comshare, 0) + ISNULL(cacct.PropVal, 0),2) as VARCHAR(20)) as 'Other Coll',
	CAST(ROUND(ISNULL(cacct.TrdgBal,0),2) as VARCHAR(20)) as 'Trading Balance',
	CAST(ROUND(ISNULL(cacct.CshMrgnBal,0),2) as VARCHAR(20)) as 'Cash / Margin Balance',
	CAST(ROUND(ISNULL(cmst.ClntApprTrdgLmt, 0),2) as VARCHAR(20)) as 'Approved Trading Lmt',
	CAST(ROUND(ISNULL(cacct.ActOSBal, 0),2) as VARCHAR(20)) as 'Available Balance',
	CAST(ROUND(ISNULL(ClntODIntAcc, 0),2) as VARCHAR(20)) as 'OD INT ACC',
	CAST(ROUND(ISNULL(ClntPCYODAcc, 0),2) as VARCHAR(20)) as 'PCY OD ACC',
	CAST(cacct.VioPosition as VARCHAR(20)) as 'Position',
	CAST(ROUND(ISNULL(cacct.MinShrSell,0),2) as VARCHAR(20)) as 'Min. Share to sell',
	/*CAST(ROUND(ISNULL(cacct.ActOsBal, 0) - ISNULL(cmst.ClntCrLmt,0),2) as VARCHAR(20)) as 'Excesses Amt',*/
	CASE
		WHEN (ISNULL(cacct.ActOsBal, 0) - ISNULL(cmst.ClntCrLmt,0)) <= 0 THEN CAST(ROUND(0,2) as VARCHAR(20))
		ELSE CAST(ROUND(ISNULL(cacct.ActOsBal, 0) - ISNULL(cmst.ClntCrLmt,0),2) as VARCHAR(20))
	END as 'Excesses Amt',
	CAST(ROUND(ISNULL(cacct.MinCashTopUp,0),2) as VARCHAR(20)) as 'Min. Cash To Top Up',
	CAST(ROUND(ISNULL(cacct.MinShrPledge,0),2) as VARCHAR(20)) as 'Min. Share To Pledge',
/*	CAST(ROUND(ISNULL(cacct.ComOsBal, 0) - ISNULL(cmst.ClntCrLmt,0),2) as VARCHAR(20)) as 'Possible Excess Amt',*/
CASE
		WHEN (ISNULL(cacct.ComOsBal, 0) - ISNULL(cmst.ClntCrLmt,0)) <= 0 THEN CAST(ROUND(0,2) as VARCHAR(20))
		ELSE CAST(ROUND(ISNULL(cacct.ComOsBal, 0) - ISNULL(cmst.ClntCrLmt,0),2) as VARCHAR(20))
	END as 'Possible Excess Amt',
	ISNULL(cmst.ClntBkAcNo,'') as 'A/C No',
	ISNULL(cmst.ClntCrLmt,0) as 'Credit Limit',
	CAST(ROUND(ISNULL(otrd.ComBuy,0),2) as VARCHAR(20)) as 'Total Committed Buy', 
	CAST(ROUND(ISNULL(otrd.DirBuy,0),2) as VARCHAR(20)) as 'Direct Buy',
	CAST(ROUND(ISNULL(otrd.OsSell,0),2) as VARCHAR(20)) as 'Outstanding Sell',
	CAST(ROUND(ISNULL(otrd.Gain,0),2) as VARCHAR(20)) as 'Gain',
	CAST(ROUND(ISNULL(otrd.Loss,0),2) as VARCHAR(20)) as 'Loss'
FROM 
	ClntMaster AS cmst WITH (NOLOCK)
JOIN 
	ClntActSumm As cacct WITH (NOLOCK) ON cacct.ClntTrdgCode = cmst.clntTrdgCode
JOIN 
	ClntCurrLmt AS clmt WITH (NOLOCK) ON clmt.ClntCode = cmst.ClntTrdgCode
JOIN 
	MstCoBrch AS mcbr WITH (NOLOCK) ON mcbr.CoBrchCode = cmst.CoBrchCode AND mcbr.CoCode = cmst.CoCode
JOIN 
	MstRegion AS mreg WITH (NOLOCK) ON mreg.RegionCode = mcbr.CoRegionCode
FULL JOIN 
	OsTradeSumm AS otrd WITH (NOLOCK) ON otrd.ClntTrdgCode = cmst.ClntTrdgCode
LEFT JOIN 
(
  SELECT 
    ClntCode, ContDate, SUM(ISNULL(ContClntBrkg, 0) - ISNULL(ContBrkgRebate, 0)) AS TotalBrkg
  FROM  Contsumm WITH (NOLOCK) 
  GROUP BY ClntCode, ContDate
) A ON A.ClntCode = cmst.Clntcode AND DATEDIFF(dd, A.ContDate, @ProcDate) = 0
LEFT JOIN
(
	SELECT 
		SUM(ABS(ISNULL(ContVal,0))) as TOVR,
		SUM(ISNULL(ContClntBrkg,0)) as BRKG,
		ClntCode
	FROM
		Contsumm WITH (NOLOCK)
	WHERE
		DATEDIFF(yy, @ProcDate, contdate) = 0
	GROUP BY
		ClntCode
) YR ON cmst.ClntTrdgCode = YR.ClntCode
LEFT JOIN
(
	SELECT 
		SUM(ABS(ISNULL(ContVal,0))) as TOVR,
		SUM(ISNULL(ContClntBrkg,0)) as BRKG,
		ClntCode
	FROM
		Contsumm WITH (NOLOCK)
	WHERE
		DATEDIFF(yy, @PrevYear, contdate) = 0
	GROUP BY
		ClntCode
) PREVYR ON cmst.ClntTrdgCode = PREVYR.ClntCode
WHERE 
	RIGHT(cmst.ClntTrdgCode,3) != 'IST' AND cmst.ClntStat <> 'C'
ORDER BY
	cmst.ClntTrdgCode
